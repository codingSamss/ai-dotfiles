#!/bin/bash
# committer - 安全的git提交辅助脚本
# 参考: steipete/agent-scripts
# 用法: committer [--force] "commit message" "file1" ["file2" ...]

set -euo pipefail
set -f  # 禁用glob展开，正确处理文件名中的特殊字符

FORCE=false

# 解析--force参数
if [[ "${1:-}" == "--force" ]]; then
    FORCE=true
    shift
fi

# 检查参数
if [[ $# -lt 2 ]]; then
    echo "用法: committer [--force] \"commit message\" \"file1\" [\"file2\" ...]"
    echo "  --force: 清理stale lock文件后重试"
    exit 1
fi

COMMIT_MSG="$1"
shift
FILES=("$@")

# 验证commit message非空
if [[ -z "$COMMIT_MSG" ]]; then
    echo "错误: commit message不能为空"
    exit 1
fi

# 检测第一个参数是否像文件路径（用户可能搞错顺序）
if [[ "$COMMIT_MSG" == *"/"* ]] || [[ "$COMMIT_MSG" == *"."* && ${#COMMIT_MSG} -lt 50 ]]; then
    if [[ -f "$COMMIT_MSG" ]] || [[ -d "$COMMIT_MSG" ]]; then
        echo "警告: 第一个参数看起来像文件路径，请确认参数顺序"
        echo "正确用法: committer \"commit message\" \"file\""
        exit 1
    fi
fi

# 阻止使用"."
for file in "${FILES[@]}"; do
    if [[ "$file" == "." ]]; then
        echo "错误: 不允许使用\".\"，请明确指定要提交的文件"
        exit 1
    fi
done

# 验证文件存在或在git历史中
for file in "${FILES[@]}"; do
    if [[ ! -e "$file" ]]; then
        # 检查是否是已删除的文件
        if ! git ls-files --deleted | grep -q "^${file}$"; then
            if ! git ls-files | grep -q "^${file}$"; then
                echo "错误: 文件不存在且不在git跟踪中: $file"
                exit 1
            fi
        fi
    fi
done

# 清空staging area
git reset HEAD -- . >/dev/null 2>&1 || true

# Stage指定文件
for file in "${FILES[@]}"; do
    if [[ -e "$file" ]]; then
        git add "$file"
    else
        # 处理已删除的文件
        git add -A "$file"
    fi
done

# 检查是否有staged changes
if git diff --cached --quiet; then
    echo "警告: 没有检测到staged changes"
    exit 0
fi

# 执行commit
commit_and_handle_error() {
    if git commit -m "$COMMIT_MSG"; then
        echo "提交成功"
        return 0
    else
        return 1
    fi
}

if ! commit_and_handle_error; then
    if [[ "$FORCE" == true ]]; then
        # 尝试清理stale lock文件
        if [[ -f ".git/index.lock" ]]; then
            echo "检测到stale lock文件，正在清理..."
            rm -f ".git/index.lock"
            if commit_and_handle_error; then
                exit 0
            fi
        fi
    fi
    echo "提交失败，使用--force可尝试清理lock文件后重试"
    exit 1
fi